
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DanhengServer WebGM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 20px;
            background: url('https://www.todaybing.com/api/today') no-repeat center center fixed;
            background-size: cover;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: background-color 0.3s;
        }
        .section {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: background-color 0.3s;
        }
        .section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .section input, .section button, .section pre {
            margin-bottom: 10px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .section button {
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .section button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow-x: auto;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        .collapsible {
            max-height: 200px; /* 设置最大高度 */
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible.expanded {
            max-height: none; /* 取消最大高度限制 */
        }
        .collapsible-button {
            cursor: pointer;
            color: #007bff;
            background: none;
            border: none;
            font-size: 14px;
            text-align: left;
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }
        .collapsible-button:hover {
            text-decoration: underline;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background: url('https://www.todaybing.com/api/today') no-repeat center center fixed;
                background-size: cover;
                color: #fff;
            }
            .container {
                background: rgba(40, 40, 40, 0.7);
            }
            .section {
                background: rgba(40, 40, 40, 0.7);
                color: #fff;
            }
            .section input, .section button, .section pre {
                background: #333;
                color: #fff;
                border: 1px solid #444;
            }
            pre {
                background: #333;
                border: 1px solid #444;
            }
            h1, h2 {
                color: #fff;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DanhengServer WebGM</h1>

        <div class="section">
            <h2>玩家 UID</h2>
            <input type="text" id="playerUid" placeholder="输入玩家 UID">
            <button onclick="savePlayerUid()">保存</button>
        </div>

        <div class="section">
            <h2>服务器信息</h2>
            <button class="collapsible-button" onclick="toggleCollapse('serverInfo')">展开 / 折叠</button>
            <div id="serverInfo" class="collapsible">
                <pre id="serverInfoResult"></pre>
            </div>
        </div>

        <div class="section">
            <h2>玩家信息</h2>
            <button class="collapsible-button" onclick="toggleCollapse('playerInfo')">展开 / 折叠</button>
            <div id="playerInfo" class="collapsible">
                <pre id="playerInfoResult"></pre>
            </div>
        </div>

        <div class="section">
            <h2>执行命令</h2>
            <input type="text" id="command" placeholder="输入命令">
            <button id="executeCommandButton" onclick="executeCommand()">执行命令</button>
            <pre id="commandResult"></pre>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.0.0/jsencrypt.min.js"></script>
    <script>
        const apiUrl = 'https://server.example.com';
        const adminKey = 'your-danheng-muip-admin-key';
        const keyType = 'PEM';
        let sessionId = null;
        let playerUid = null;
        let rsaPublicKey = null;

        async function authorize() {
            const response = await fetch(`${apiUrl}/auth_admin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    admin_key: adminKey,
                    key_type: keyType
                })
            });
            const result = await response.json();
            if (result.code === 0) {
                sessionId = result.data.sessionId;
                rsaPublicKey = result.data.rsaPublicKey; // 保存 rsaPublicKey
                console.log('授权成功:', sessionId);
            } else {
                console.error('授权失败:', result.message);
            }
        }

        async function executeCommand() {
            if (!playerUid) {
                alert('请先保存玩家 UID');
                return;
            }
            await authorize(); // 每次执行命令前重新进行认证
            const command = document.getElementById('command').value;
            if (!command) {
                alert('命令不能为空');
                return;
            }
    
            // 使用 RSA 公钥加密命令
            const encrypt = new JSEncrypt();
            encrypt.setPublicKey(rsaPublicKey); // 使用从 authorize 获取的 rsaPublicKey
            const encryptedCommand = encrypt.encrypt(command);

            if (!encryptedCommand) {
                alert('命令加密失败');
                return;
            }
    
            const response = await fetch(`${apiUrl}/exec_cmd`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    SessionId: sessionId,
                    Command: encryptedCommand,
                    TargetUid: playerUid
                })
            });
            const result = await response.json();
            
            // 只提取 message 字段并 base64 解码
            const message = result.data.message;
            const decodedMessage = atob(message);
            
            // 处理可能的编码问题
            // 创建一个 TextDecoder 实例，用于解码可能的非 UTF-8 编码
            const decoder = new TextDecoder('utf-8');
            const encodedBytes = new Uint8Array(decodedMessage.split('').map(c => c.charCodeAt(0)));
            const decodedText = decoder.decode(encodedBytes);

            document.getElementById('commandResult').textContent = decodedText;
        }

        async function getServerInformation() {
            await authorize(); // 每次获取服务器信息前重新进行认证
            const response = await fetch(`${apiUrl}/server_information?SessionId=${encodeURIComponent(sessionId)}`, {
                method: 'GET'
            });
            const result = await response.json();
            const serverInfoResult = document.getElementById('serverInfoResult');
            serverInfoResult.textContent = JSON.stringify(result, null, 2);
            handleOutputLength();
        }

        async function getPlayerInformation() {
            await authorize(); // 每次获取玩家信息前重新进行认证
            if (!playerUid) return;
            const response = await fetch(`${apiUrl}/player_information?SessionId=${encodeURIComponent(sessionId)}&Uid=${encodeURIComponent(playerUid)}`, {
                method: 'GET'
            });
            const result = await response.json();
            const playerInfoResult = document.getElementById('playerInfoResult');
            playerInfoResult.textContent = JSON.stringify(result, null, 2);
            handleOutputLength();
        }

        async function savePlayerUid() {
            playerUid = document.getElementById('playerUid').value;
            if (!playerUid) {
                alert('玩家 UID 不能为空');
                return;
            }
            await getPlayerInformation();
        }

        async function refreshData() {
            await getServerInformation();
            if (playerUid) {
                await getPlayerInformation();
            }
        }

        function toggleCollapse(id) {
            const element = document.getElementById(id);
            if (element.classList.contains('expanded')) {
                element.classList.remove('expanded');
            } else {
                element.classList.add('expanded');
            }
        }

        function handleOutputLength() {
            const serverInfoResult = document.getElementById('serverInfoResult');
            const playerInfoResult = document.getElementById('playerInfoResult');
            
            if (serverInfoResult.textContent.split('\n').length > 100) {
                document.getElementById('serverInfo').classList.add('collapsible');
            }
            if (playerInfoResult.textContent.split('\n').length > 100) {
                document.getElementById('playerInfo').classList.add('collapsible');
            }
        }

        window.onload = async function() {
            await authorize();
            await refreshData();
            setInterval(refreshData, 10000); // 每10秒刷新一次数据
        }

        // 初始禁用执行命令按钮，保存玩家 UID 后启用
        document.getElementById('playerUid').addEventListener('input', function () {
            document.getElementById('executeCommandButton').disabled = !this.value;
        });
    </script>
</body>
</html>
